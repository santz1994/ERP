global:
  resolve_timeout: 5m
  # SMTP Configuration for email alerts
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_auth_username: '${ALERTMANAGER_EMAIL:-admin@qutykarunia.com}'
  smtp_auth_password: '${ALERTMANAGER_EMAIL_PASSWORD:-password}'
  smtp_require_tls: true

# The root route contains the routing rules. 
# Routing is done on incoming alerts based on label matching.
route:
  # The group by clause specifies the labels to group alerts.
  group_by: ['alertname', 'cluster', 'service']
  
  # Default group wait/interval time
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  
  # Default receiver - goes to PagerDuty
  receiver: 'default'
  
  # Sub-routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: true

    # Metal detector critical alert
    - match:
        alertname: MetalDetectorFailureAlert
      receiver: 'metal-detector-incident'
      group_wait: 0s
      repeat_interval: 5m
      continue: true

    # Database alerts
    - match:
        component: database
      receiver: 'database-team'
      group_wait: 30s
      repeat_interval: 1h

    # API alerts
    - match:
        component: api
      receiver: 'api-team'
      group_wait: 30s
      repeat_interval: 1h

    # Production workflow alerts
    - match:
        component: workflow
      receiver: 'workflow-team'
      group_wait: 10s
      repeat_interval: 1h

    # Quality control alerts
    - match:
        component: quality
      receiver: 'quality-team'
      group_wait: 30s
      repeat_interval: 1h

    # Infrastructure alerts
    - match:
        component: infrastructure
      receiver: 'infrastructure-team'
      group_wait: 30s
      repeat_interval: 2h

    # Monitoring alerts
    - match:
        component: monitoring
      receiver: 'monitoring-team'
      group_wait: 10s
      repeat_interval: 30m

    # Backup alerts
    - match:
        component: backup
      receiver: 'backup-team'
      group_wait: 5m
      repeat_interval: 1h

    # Warning alerts
    - match:
        severity: warning
      receiver: 'default'
      group_wait: 5m
      repeat_interval: 12h

# Receivers define where notifications are sent to.
receivers:
  - name: 'null'

  - name: 'default'
    email_configs:
      - to: 'ops-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[{{ .GroupLabels.severity | upper }}] {{ .GroupLabels.alertname }}'

  - name: 'critical-alerts'
    email_configs:
      - to: 'oncall@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: 'ðŸš¨ CRITICAL ALERT: {{ .GroupLabels.alertname }} - IMMEDIATE ACTION REQUIRED'
          Priority: 'Urgent'

  - name: 'metal-detector-incident'
    email_configs:
      - to: 'quality-manager@qutykarunia.com,production-manager@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: 'ðŸš¨ CRITICAL: METAL DETECTED IN FINISHED PRODUCT - PRODUCTION STOPPED'
          Priority: 'Urgent'

  - name: 'database-team'
    email_configs:
      - to: 'dba-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[Database] {{ .GroupLabels.alertname }}'

  - name: 'api-team'
    email_configs:
      - to: 'backend-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[API] {{ .GroupLabels.alertname }}'

  - name: 'workflow-team'
    email_configs:
      - to: 'production-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[Production] {{ .GroupLabels.alertname }}'

  - name: 'quality-team'
    email_configs:
      - to: 'qa-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[QA] {{ .GroupLabels.alertname }}'

  - name: 'infrastructure-team'
    email_configs:
      - to: 'devops-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[Infrastructure] {{ .GroupLabels.alertname }}'

  - name: 'monitoring-team'
    email_configs:
      - to: 'monitoring-team@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'

  - name: 'backup-team'
    email_configs:
      - to: 'backup-admin@qutykarunia.com'
        from: 'alertmanager@qutykarunia.com'
        headers:
          Subject: '[Backup] {{ .GroupLabels.alertname }}'

# Inhibition rules - silence alerts based on other alerts
inhibit_rules:
  # Inhibit APIServiceDown if NodeDown
  - source_match:
      alertname: 'NodeDown'
    target_match:
      alertname: 'APIServiceDown'
    equal: ['instance']

  # Inhibit PostgreSQLDown if NodeDown
  - source_match:
      alertname: 'NodeDown'
    target_match:
      alertname: 'PostgreSQLDown'
    equal: ['instance']

  # Inhibit slow query warnings if database is down
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match:
      alertname: 'SlowQueries'
    equal: ['instance']

  # Inhibit high memory if node is restarting
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: 'High.*'
    equal: ['instance']

  # Inhibit connection pool warnings if database is down
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match:
      alertname: 'DBConnectionPoolExhausted'
    equal: ['instance']

